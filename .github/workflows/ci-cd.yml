name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # Job 1: Environment Validation
  validate-environment:
    name: ðŸ” Validate Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate environment configuration
        run: |
          # Create test environment file
          cat > .env.test << EOF
          NODE_ENV=production
          NEXT_PUBLIC_APP_URL=https://test.example.com
          NEXTAUTH_SECRET=test-secret-key-with-minimum-32-characters
          NEXT_PUBLIC_API_URL=https://api.test.example.com
          EOF

          # Test environment validation
          NODE_ENV=production pnpm type-check

  # Job 2: Code Quality & Security
  code-quality:
    name: ðŸ” Code Quality & Security
    runs-on: ubuntu-latest
    needs: validate-environment
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript type check
        run: pnpm type-check

      - name: ESLint check
        run: pnpm lint

      - name: Prettier format check
        run: pnpm format:check

      - name: Security audit
        run: pnpm audit --audit-level moderate

      - name: Check for TODO/FIXME comments
        run: |
          if grep -r "TODO\|FIXME\|HACK\|XXX" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx"; then
            echo "âŒ Found TODO/FIXME comments in code"
            exit 1
          else
            echo "âœ… No TODO/FIXME comments found"
          fi

  # Job 3: Testing
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: validate-environment
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test:coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: Check coverage threshold
        run: |
          # Extract coverage percentage
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Coverage: ${COVERAGE}%"

          # Fail if coverage is below threshold
          if (( $(echo "${COVERAGE} < 70" | bc -l) )); then
            echo "âŒ Coverage ${COVERAGE}% is below threshold (70%)"
            exit 1
          else
            echo "âœ… Coverage ${COVERAGE}% meets threshold"
          fi

  # Job 4: Build & Performance
  build:
    name: ðŸ—ï¸ Build & Performance
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          NEXT_PUBLIC_APP_URL: https://example.com
          NEXTAUTH_SECRET: build-secret-key-with-minimum-32-characters

      - name: Analyze bundle size
        run: |
          # Install bundle analyzer
          pnpm add -D @next/bundle-analyzer

          # Generate bundle analysis
          ANALYZE=true pnpm build

          # Check bundle size limits
          echo "ðŸ“¦ Bundle Analysis Complete"

      - name: Test health endpoint
        run: |
          # Start the built application
          pnpm start &
          SERVER_PID=$!

          # Wait for server to start
          sleep 10

          # Test health endpoint
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health)

          if [ "$HEALTH_RESPONSE" != "200" ]; then
            echo "âŒ Health check failed with status: $HEALTH_RESPONSE"
            kill $SERVER_PID
            exit 1
          else
            echo "âœ… Health check passed"
          fi

          # Cleanup
          kill $SERVER_PID

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            .next/
            public/
          retention-days: 7

  # Job 5: Security Scanning
  security:
    name: ðŸ”’ Security Scanning
    runs-on: ubuntu-latest
    needs: validate-environment
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Setup Node.js for dependency check
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for known vulnerabilities
        run: |
          # Run security audit
          pnpm audit --audit-level moderate

          # Check for outdated dependencies
          pnpm outdated || true

  # Job 6: Lighthouse Performance Audit
  lighthouse:
    name: ðŸš¨ Lighthouse Audit
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: Run Lighthouse CI
        run: |
          # Install Lighthouse CI
          npm install -g @lhci/cli@0.11.x

          # Start application
          pnpm start &
          SERVER_PID=$!

          # Wait for server
          sleep 15

          # Run Lighthouse
          lhci collect --url=http://localhost:3000
          lhci assert

          # Cleanup
          kill $SERVER_PID
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # Job 7: Deploy to Staging
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.jobpay.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          # Add your deployment script here
          # Example: rsync, docker push, vercel deploy, etc.

      - name: Run post-deployment health check
        run: |
          # Wait for deployment
          sleep 30

          # Health check
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://staging.jobpay.com/api/health)

          if [ "$HEALTH_RESPONSE" != "200" ]; then
            echo "âŒ Staging health check failed"
            exit 1
          else
            echo "âœ… Staging deployment successful"
          fi

  # Job 8: Deploy to Production
  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, security, lighthouse]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://jobpay.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: Deploy to production
        run: |
          echo "ðŸš€ Deploying to production environment..."
          # Add your production deployment script here

      - name: Run post-deployment health check
        run: |
          # Wait for deployment
          sleep 30

          # Health check
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://jobpay.com/api/health)

          if [ "$HEALTH_RESPONSE" != "200" ]; then
            echo "âŒ Production health check failed"
            exit 1
          else
            echo "âœ… Production deployment successful"
          fi

      - name: Notify team
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Production deployment completed successfully"
            # Add Slack notification or email here
          else
            echo "âŒ Production deployment failed"
            # Add alert notification here
          fi

  # Job 9: Notify Status
  notify:
    name: ðŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [validate-environment, code-quality, test, build, security]
    if: always()
    steps:
      - name: Determine overall status
        run: |
          if [[ "${{ needs.validate-environment.result }}" == "success" && 
                "${{ needs.code-quality.result }}" == "success" && 
                "${{ needs.test.result }}" == "success" && 
                "${{ needs.build.result }}" == "success" && 
                "${{ needs.security.result }}" == "success" ]]; then
            echo "OVERALL_STATUS=success" >> $GITHUB_ENV
            echo "STATUS_EMOJI=âœ…" >> $GITHUB_ENV
            echo "STATUS_MESSAGE=All checks passed!" >> $GITHUB_ENV
          else
            echo "OVERALL_STATUS=failure" >> $GITHUB_ENV
            echo "STATUS_EMOJI=âŒ" >> $GITHUB_ENV
            echo "STATUS_MESSAGE=Some checks failed" >> $GITHUB_ENV
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const status = process.env.OVERALL_STATUS;
            const emoji = process.env.STATUS_EMOJI;
            const message = process.env.STATUS_MESSAGE;

            const comment = `
            ## ${emoji} CI/CD Pipeline Results

            **Status**: ${message}

            ### Pipeline Summary
            - Environment Validation: ${{ needs.validate-environment.result }}
            - Code Quality: ${{ needs.code-quality.result }}
            - Tests: ${{ needs.test.result }}
            - Build: ${{ needs.build.result }}
            - Security: ${{ needs.security.result }}

            ${status === 'success' ? 'ðŸŽ‰ Ready to merge!' : 'ðŸ”§ Please fix the failing checks before merging.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
